import { IXyoBluetoothDevice, IXyoScan } from "@xyo-network/ble-central"
import { XyoLogger } from "@xyo-network/logger"
// import noble from '@s524797336/noble-mac'
import noble from '@abandonware/noble'
import { NobleDevice } from "./noble-device"

export class NobleScan implements IXyoScan {
  private logger = new XyoLogger(false, false)
  private inRangeDevices: Record<string, IXyoBluetoothDevice> = {}

  constructor () {
    noble.on("stateChange", async (state) => {
      this.stateChange(state)
      // this.startScan()
    })
    noble.on("discover", async (peripheral) => {
      this.discover(peripheral)
    })
    setInterval(this.cleanDevices, 1_000)
  }

  // default no async/await
  public async startScan(): Promise<void> {
    // eslint-disable-next-line no-async-promise-executor
    return new Promise(async (resolve, reject) => {
      if (noble.state === "poweredOn") {

        const callback = () => {
          this.logger.info("Scanner stared successfully")
          // noble.removeListener('scanStart', callback)
          noble.removeListener(`scanStart`, callback)
          resolve()
        }

        this.logger.info("Trying to start scanner")
        noble.on('scanStart', callback)

        try { noble.startScanning([], false) }
        catch (error) { reject(`startScan() error`) }
        return
      }
      this.logger.error("Noble is not powered on")
      reject()
    })
  }

  // default no async/await
  public async stopScan(): Promise<void> {
    // eslint-disable-next-line no-async-promise-executor
    return new Promise(async (resolve, reject) => {
      this.logger.info("Stopping noble scanner")
      // noble.removeAllListeners('scanStop')
      try {
        noble.stopScanning() 
        resolve()
      }
      catch (error) { reject(`stopScan() error`) }
    })
  }

  public getDevices(): IXyoBluetoothDevice[] {
    const returnArray: IXyoBluetoothDevice[] = []

    for (const [ , value ] of Object.entries(this.inRangeDevices)) {
      returnArray.push(value)
    }
    return returnArray
  }

  private cleanDevices = () => {
    for (const id in this.inRangeDevices) {
      if (Date.now() - (this.inRangeDevices[ id ].lastSeen) > 5_000) {
        delete this.inRangeDevices[ id ]
      }
    }
  }

  private stateChange = (state: string) => {
    this.logger.info(`Noble state change: ${ state }`)
  }

  private discover(peripheral: noble.Peripheral) {
    const entered = !this.inRangeDevices[ peripheral.id ]

    if (entered) {
      this.inRangeDevices[ peripheral.id ] = new NobleDevice(peripheral)
    }
    this.inRangeDevices[ peripheral.id ].lastSeen = Date.now()
  }
}
