import { IXyoAdvertisement, IXyoBluetoothDevice, IXyoService } from "@xyo-network/ble-central"
import { XyoLogger } from '@xyo-network/logger'
import { NobleAdvertisement } from './noble-advertisement'
import { NobleService } from './noble-service'
// import noble from '@s524797336/noble-mac'
import noble from '@abandonware/noble'

export class NobleDevice implements IXyoBluetoothDevice {
  public logger: XyoLogger = new XyoLogger(false, false)
  public device: noble.Peripheral
  public lastSeen: number = Date.now()

  public get id(): string {
    return this.device.id
  }

  public get uuid(): string {
    return this.device.uuid
  }

  public get connectable(): boolean {
    return this.device.connectable
  }

  public get advertisement(): IXyoAdvertisement {
    return new NobleAdvertisement(this.device.advertisement)
  }

  public get rssi(): number {
    return this.device.rssi
  }

  public get services(): IXyoService[] {
    const returnArray: IXyoService[] = []

    this.device.services.forEach((service) => {
      returnArray.push(new NobleService(service))
    })

    return returnArray
  }

  public get state(): 'error' | 'connecting' | 'connected' | 'disconnecting' | 'disconnected' {
    return this.device.state
  }

  constructor (device: noble.Peripheral) {
    this.device = device
  }

  public async connect(): Promise<void> {
    // eslint-disable-next-line no-async-promise-executor
    return new Promise(async (resolve, reject) => {
      this.logger.info(`Trying to connect to device with id: ${ this.device.id }`)

      const timeout = setTimeout(async () => {
        // this.device.cancelConnect()
        reject(`NobleDevice.connect(): setTimeout()`)
      }, 10_000)

      try {
        noble.reset() // testing
        await this.device.connectAsync()
        clearTimeout(timeout)
        this.logger.info(`Connected to device with id: ${ this.device.id }`)
        resolve(undefined)
      } catch { 
        clearTimeout(timeout)
        reject(`connect(): Error`)
      }
    })
  }

  public async disconnect(): Promise<void> {
    // eslint-disable-next-line no-async-promise-executor
    return new Promise(async (resolve, reject) => {
      this.logger.info(`Trying to disconnect to device with id: ${ this.device.id }`)

      try {
        // noble.reset() // testing
        await this.device.disconnectAsync()
        this.logger.info(`Disconnected from device with id: ${ this.device.id }`)
        resolve(undefined)
      } catch {
        reject(`disconnect(): Error`)
      }
    })
  }

  public async updateRssi(): Promise<number> {
    // eslint-disable-next-line no-async-promise-executor
    return new Promise(async (resolve, reject) => {
      this.logger.info(`Trying to update device RSSI with id: ${ this.device.id }`)

      try {
        const rssi = await this.device.updateRssiAsync()
        this.logger.info(`Updated RSSI for device with id: ${ this.device.id }`)
        resolve(rssi)
      } catch {
        this.logger.error(`Error updating RSSI for device with id: ${ this.device.id }`)
        reject(`updateRssi(): Error`)
      }
    })
  }

  public async discoverServicesForUuids(serviceUUIDs: string[]): Promise<IXyoService[]> {
    // eslint-disable-next-line no-async-promise-executor
    return new Promise(async (resolve, reject) => {
      this.logger.info(`Trying to discover services for device with id: ${ this.device.id }`)

      try {
        this.logger.info(`Successfully discovered services for device with id: ${ this.device.id }`)
        const services = await this.device.discoverServicesAsync(serviceUUIDs)
        const returnArray: IXyoService[] | PromiseLike<IXyoService[]> | NobleService[] = []
        
        for (const service of services) {
          returnArray.push(new NobleService(service))
        }
        // services.forEach((service: noble.Service) => {
        //   returnArray.push(new NobleService(service))
        // }
                        
        resolve(returnArray)
      } catch {
        reject(`discoverServices(): Error`)
      }
    })
  }

  // default no async/await
  public discoverServices(): Promise<IXyoService[]> {
    this.logger.info(`Attempting to discover services...`)
    return this.discoverServicesForUuids([])
  }
}
